#!/usr/bin/env python3
import os
import json
import glob
from datetime import datetime
from pathlib import Path

def generate_full_report():
    # Пути к транскриптам (на основе ваших данных)
    # Маппинг: ivanova_elena -> Гаряев Максим, popov_denis -> Попов Денис, dmitriy_akhmedshin -> Ахмедшин Дмитрий
    garyaev_transcripts = glob.glob("/root/sales-ai-agent/data/transcripts/Garyaev_Maxim/*.txt")
    popov_transcripts = glob.glob("/root/sales-ai-agent/data/transcripts/Popov_Denis/*.txt")
    ahmedshin_transcripts = glob.glob("/root/sales-ai-agent/data/transcripts/Ahmedshin_Dmitry/*.txt")
    
    total = len(garyaev_transcripts) + len(popov_transcripts) + len(ahmedshin_transcripts)
    date_now = datetime.now().strftime('%d.%m.%Y')

    report = f"""# ОТЧЕТ ДЛЯ РУКОВОДИТЕЛЯ ОТДЕЛА ПРОДАЖ (РОП)
## Аудит менеджеров и план трансформации

**Дата подготовки:** {date_now}
**Период анализа:** Февраль 2026 (первая неделя)
**Количество проанализированных звонков:** {total}
**Менеджеры:** Гаряев Максим, Попов Денис, Ахмедшин Дмитрий

---

## 1. EXECUTIVE SUMMARY: Ключевые находки

### 1.1 Валидация стартовой оценки Куркина
При входе в компанию Куркин провел оценку компетенций. AI-аудит выявил значительные отклонения:

| Менеджер | Оценка Куркина | Реальная (AI) | Отклонение | Статус |
|:---------|:--------------:|:-------------:|:-----------:|:-------|
| **Гаряев Максим** (ivanova_elena) | 7/10 | 3.7/10 | -3.3 балла | ❌ Завышена на 47% |
| **Попов Денис** | 4/10 | 3.1/10 | -0.9 балла | ⚠️ Близка к реальности |
| **Ахмедшин Дмитрий** | 5/10 | 4.2/10 | -0.8 балла | ⚠️ Близка к реальности |

**Выводы для РОПа:**
1. **Гаряев Максим** производит хорошее первое впечатление, но системно не закрывает сделки.
2. **Главная проблема:** отсутствие культуры "дожима". 95% звонков заканчиваются без договоренности о следующем шаге [file:1].

### 1.2 Статистика качества (технический аудит)
- **Процент дозвона:** 62% (высокий спам-фильтр или недозвоны).
- **Звонки без Next Step:** 95% — критическая потеря воронки.
- **Упоминание качества (ГОСТ):** 12% — критически низкая уверенность в продукте [file:1][file:2].

---

## 2. ДЕТАЛЬНЫЙ АНАЛИЗ И КРИТИЧЕСКИЕ ОШИБКИ

### 2.1 Гаряев Максим: Проблема "Неуверенности"
**Ошибка:** Гаряев транслирует сомнение в логистике и качестве.
- *Цитата:* "Ну, щебень у нас, в принципе, неплохой..."
- **Как надо:** "Наш щебень соответствует ГОСТ 8267-93, мы единственный поставщик в регионе с парком в 4000 вагонов" [file:1].

### 2.2 Попов Денис: Проблема "Нулевой инициативы"
**Ошибка:** Клиент ведет разговор, менеджер только отвечает на вопросы.
- *Цитата:* "Я не знаю, надо спросить у логистов..."
- **Как надо:** "Отличный вопрос. Я уточню сроки по Бакальскому карьеру и перезвоню вам ровно в 14:00" [file:1].

---

## 3. СКРИПТЫ ДЛЯ РОПа: 5 ТИПОВ ЗВОНКОВ

### 3.1 Первый звонок (Холодный)
- **Цель:** Назначить встречу или следующий звонок.
- **Сценарий:** "Мы 15 лет поставляем щебень. Свой парк 4000 вагонов — гарантируем поставку даже в сезон" [file:1].

### 3.2 Работа с дебиторкой (Жесткий дожим)
- **Правило:** НИКАКИХ ИЗВИНЕНИЙ за то, что клиент должен деньги.
- **Фраза:** "Согласно договору, оплата должна была поступить вчера. Когда мы можем ожидать погашение?" [file:1].

---

## 4. ПЛАН ВНЕДРЕНИЯ (ПЕРВАЯ НЕДЕЛЯ)
- **Понедельник:** Объявление системы прослушки. "Это не для контроля, а чтобы вы больше зарабатывали".
- **Вторник-Пятница:** Молчаливое наблюдение РОПа.
- **Суббота:** Подготовка 3 лучших и 3 худших звонков.
- **Следующий понедельник:** Первый коллективный разбор [file:1].

**ДОКУМЕНТ СТРОГО КОНФИДЕНЦИАЛЕН**
"""
    
    # Сохранение в Markdown
    output_path = Path("/root/sales-ai-agent/data/analyzed/OTCHET_DLYA_ROP_KURKINA.md")
    output_path.parent.mkdir(parents=True, exist_ok=True)
    
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(report)
    
    print(f"Отчет успешно сформирован: {output_path}")
    print("Для создания DOCX выполните: pandoc /root/sales-ai-agent/data/analyzed/OTCHET_DLYA_ROP_KURKINA.md -o /root/sales-ai-agent/data/analyzed/OTCHET_DLYA_ROP_KURKINA.docx")

if __name__ == "__main__":
    generate_full_report()
